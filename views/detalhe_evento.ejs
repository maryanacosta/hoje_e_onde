<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= evento ? evento.titulo : 'Evento N√£o Encontrado' %> - Hoje √â Onde?</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css"> 
    <style>
        .event-banner {
            max-height: 400px;
            object-fit: cover;
            border-radius: .375rem;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <a href="/" class="btn btn-outline-secondary mb-4">‚Üê Voltar para a Home</a>

        <% if (!evento) { %>
            <div class="alert alert-danger" role="alert">
                Evento n√£o encontrado ou n√£o aprovado.
            </div>
        <% } else { %>
            <div class="card shadow-lg border-0">
                <div class="position-relative" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalImagem">
                    <img src="/img/<%= evento.imagem || 'default_event_large.jpg' %>" 
                        class="card-img-top event-banner" 
                        alt="Banner do Evento">
                    <span class="position-absolute top-0 end-0 m-3 badge bg-dark bg-opacity-75 fs-6 shadow-sm">
                        Clique para ampliar
                    </span>
                </div>
                
                <div class="card-body p-md-5">
                    <h1 class="card-title text-warning mb-3"><%= evento.titulo %></h1>
                    <span class="badge bg-info text-dark mb-3"><%= evento.tipo %></span>
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <h4>üìÖ Data e Hora</h4>
                            <p class="mb-1"><strong>Data:</strong> <%= new Date(evento.data).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
                            <p class="mb-1"><strong>Hor√°rio/Dura√ß√£o:</strong> <%= evento.duracao || 'N√£o informado' %></p>
                        </div>
                        <div class="col-md-6">
                            <h4>üìç Local</h4>
                            <p class="mb-1"><strong>Local:</strong> <%= evento.local %></p>
                        </div>
                    </div>
                    
                    <h4 class="mt-4">üìù Descri√ß√£o Detalhada</h4>
                    <p class="card-text text-muted"><%= evento.descricao %></p>

                    <% if (evento.publicoAlvo) { %>
                        <h4 class="mt-4">üë• P√∫blico Alvo</h4>
                        <p class="card-text"><%= evento.publicoAlvo %></p>
                    <% } %>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-success me-2 fs-5">üëç <%= evento.TotalPositivo %></span>
                            <!--<span class="badge bg-danger me-2 fs-5">üëé <%= evento.TotalNegativo %></span>-->
                        </div>
                        
                        <% if (isLogged) { %>
                            <div class="d-flex">
                                <button id="vote-positivo" data-voto="positivo" class="btn btn-lg me-2 
                                    <%= usuarioVoto === 'positivo' ? 'btn-success' : 'btn-outline-success' %>">
                                    üëç Gosto
                                </button>
                                
                                <button id="salvar-btn" data-evento-id="<%= evento.id %>" class="btn btn-lg 
                                    <%= estaSalvo ? 'btn-success' : 'btn-main-bold' %>">
                                    <%= estaSalvo ? ' Salvo ‚úÖ' : ' Salvar' %>
                                </button>
                            </div>
                        <% } else { %>
                            <div class="alert alert-warning p-2 m-0">
                                <a href="/login" class="alert-link">Fa√ßa Login</a> para votar e salvar este evento.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <% if (isLogged && evento) { %>
    <script>
        const eventoId = parseInt('<%= evento.id %>', 10);
        
        // --- l√≥gica de vota√ß√£o ---
        document.querySelectorAll('#vote-positivo').forEach(button => { 
            button.addEventListener('click', function() {
                fetch('/votar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eventoId: eventoId })
                })
                .then(response => { // verifica se houve redirecionamento para login
                    if(response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    return response.json();
                })
                .then(data => { // trata a resposta
                    if (data.success) {
                        // atualiza o contador de likes
                        const badgeContador = document.querySelector('.badge.bg-success.fs-5');
                        if (badgeContador) {
                            badgeContador.innerText = 'üëç ' + data.counts.TotalPositivo;
                        }

                        // atualiza a cor do bot√£o
                        const btnGosto = document.getElementById('vote-positivo');
                        
                        if (data.acao === 'adicionado') { // se o usuario deu like
                            // fica verde
                            btnGosto.classList.remove('btn-outline-success');
                            btnGosto.classList.add('btn-success');
                        } else if (data.acao === 'removido') { // se ele tira
                            // fica branco
                            btnGosto.classList.remove('btn-success');
                            btnGosto.classList.add('btn-outline-success');
                        }
                    } else {
                        // em caso de falha
                        Swal.fire({
                            icon: 'error',
                            title: 'Ops...',
                            text: data.message
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao votar:', error);
                });
            });
        });

        // --- l√≥gica de Salvamento ---
        document.getElementById('salvar-btn').addEventListener('click', function(e) {
            e.preventDefault(); 
            e.stopPropagation(); 

            const button = this;

            fetch('/salvar-evento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ eventoId: eventoId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Salvo!',
                        text: data.message,
                        showConfirmButton: false,
                        timer: 1500
                    });

                    button.classList.remove('btn-outline-warning');
                    button.classList.add('btn-success');
                    button.innerText = '‚úÖ Salvo';
                }
                else {
                    // se j√° estava salvo ou outro problema
                    Swal.fire({
                        icon: 'info',
                        title: 'Aten√ß√£o',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Ocorreu um erro ao salvar o evento.'
                });
            });
        });
    </script>
    <% } %> <!-- fim do isLogged -->
    <!-- modal p expandir a imagem -->
    <% if (evento) { %> <div class="modal fade" id="modalImagem" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl"> 
            <div class="modal-content bg-transparent border-0"> 
                <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="/img/<%= evento.imagem || 'default_event_large.jpg' %>" class="img-fluid rounded" alt="Imagem Ampliada">
                </div>
            </div>
        </div>
    </div>
    <% } %>
</body>
</html>